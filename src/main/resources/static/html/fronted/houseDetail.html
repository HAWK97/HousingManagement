<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>房屋详情</title>
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- 可选的 Bootstrap 主题文件（一般不用引入） -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <script src="../../js/jquery-3.1.1.min.js"></script>
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
    <script src="../../js/template.js"></script>
    <script src="../../js/global.js/"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

</head>
<style>
    * {
        margin: 0;
        padding: 0;
    }

    .interval{
        margin-top: 20px;
    }

</style>
<body>
<div style="margin: 0 auto;width: 1000px">
    <nav class="navbar" style="height: 120px; background-color: #32363a">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <a href="../fronted/index.html">
                        <img src="../../img/brand.png">
                    </a>
                </div>
            </div>
        </div>
    </nav>
    <!--TODO  渲染模板-->
    <div id="houseDetailDiv">
        <script type="text/html" id="houseDetailJs">

            <div class="main">
                <div style="float: left">
                    <!--轮播图开始-->
                    <div id="myCarousel" class="carousel slide">

                        <!-- 轮播（Carousel）指标 -->
                        <ol class="carousel-indicators">
                            <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
                            {{each imgList}}
                            <li data-target="#myCarousel" data-slide-to="{{$index + 1}}"></li>
                            {{/each}}
                        </ol>
                        <!-- 轮播（Carousel）项目 -->
                        <div class="carousel-inner">
                            <div class="item active">
                                <img src="{{titleImg}}" alt="First slide" style="width: 700px;height: 500px">
                            </div>
                            {{each imgList}}
                            <div class="item">
                                <img src="{{$value}}" alt="Second slide" style="width: 700px;height: 500px">
                            </div>
                            {{/each}}
                        </div>
                        <div style="clear: both"></div>
                        <!-- 轮播（Carousel）导航 -->
                        <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
                            <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                            <span class="sr-only">Previous</span>
                        </a>
                        <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
                            <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                            <span class="sr-only">Next</span>
                        </a>
                    </div>
                    <!--轮播图结束-->
                </div>
                <!--房屋详细信息-->
                <div style="float: right;width: 200px">
                    <!--TODO   获取用户信息 样式改变-->
                    <div>
                        <img src="{{userProfile}}" width="200px" height="200px">
                    </div>
                    <div class="interval"><span style="font-size: 20px;color: gray">昵称:</span><span>{{sellerName}}</span></div>
                    <div class="interval"><span style="color: gray;font-size: 20px">地址:</span>
                        <span style="color: black;font-size: 18px">{{house.address}}</span></div>
                    <div class="interval"><span style="color: gray;font-size: 20px">类型:</span>
                        <span style="color: black;font-size: 18px">{{house.type}}</span></div>
                    <div class="interval"><span style="color: gray;font-size: 20px">描述:</span>
                        <span style="color: black;font-size: 18px">{{house.description}}</span></div>
                    <div  class="interval"><span style="color: gray;font-size: 20px">租金:</span>
                        <span style="color: red;font-size: 18px">{{house.price}}￥</span></div>
                    <div class="interval"><span style="font-size: 20px; color: gray">电话</span>{{sellerPhoneNum}}</div>
                    <span style="display: none" id="sellerId">{{sellerId}}</span>
                    <button class="btn btn-success btn-block" onclick="sendInvitation()">发起预约</button>
                </div>
                <!--房屋详细信息-->
                <div style="clear: both"></div>
            </div>
        </script>
    </div>
    <!--评论列表-->
    <div id="commentDiv">
        <script type="text/html" id="commentJs">
            {{each data}}
            <div class="media">
                <div class="media-left">
                    <a href="#">
                        <img class="media-object" src="{{$value.userProfile}}" width="50px" height="50px">
                    </a>
                </div>
                <div class="media-body">
                    <h6 class="media-heading">{{$value.comment.createTime}}</h6>
                    {{$value.comment.content}}
                </div>
            </div>
            {{/each}}
        </script>
    </div>
    <!--评论列表结束-->
    <form>
        <div class="form-group">
            <label for="comment">评论：</label>
            <input type="text" class="form-control" id="comment" placeholder="评论">
        </div>
        <button class="btn btn-success" onclick="sendComment()" type="submit">发表评论</button>
    </form>
</div>


<script type="application/javascript">
    var houseId = 0;
    $(function () {
        //获取地址栏id
        houseId = getQueryString("id");
        //渲染房屋信息
        findHouseById();
        //渲染评论
        findCommentList();


        /**
         * 根据id查询房屋信息
         */
        function findHouseById() {
            $.ajax({
                url: window.globalConfig.baseUrl + "/house/toHouseDetail/" + houseId,
                type: "get",
                success: function (data) { //成功回调
                    console.log(data.data);
                    if (data.code === 0) {
                        var html = template("houseDetailJs", data.data);
                        document.getElementById("houseDetailDiv").innerHTML = html;
                    }
                }
            });
        }
    });


    /**
     * 发表评论
     */
    function sendComment() {
        console.log("房子id是:" + houseId);
        $.ajax({
            url: window.globalConfig.baseUrl + "/comment/addComment",
            type: "POST",
            data: {
                content: $("#comment").val(),
                houseId: houseId
            },
            success: function (data) { //成功回调
                if (data.code === 0) {
                    findCommentList();
                }
            }
        });
    }


    /**
     *  查询评论列表
     */
    function findCommentList() {
        $.ajax({
            url: window.globalConfig.baseUrl + "/comment/getComment/" + houseId,
            type: "get",
            success: function (data) { //成功回调
                if (data.code === 0) {
                    var html = template("commentJs", data);
                    document.getElementById("commentDiv").innerHTML = html;
                }
            }
        });
    }


    /**
     * 获取地址栏参数
     * @param name
     * @returns {*}
     */
    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]);
        return null;
    }

    /**
     * 发出看房邀请
     * @param sellerId 售房人id
     */
    function sendInvitation(sellerId) {
        $.ajax({
            url: window.globalConfig.baseUrl + "/invitation/sendInvitation",
            data: {
                houseId: houseId,
                sellerId: $("#sellerId").text(),
                time: new Date().toLocaleDateString()
            },
            type: "get",
            success: function (data) { //成功回调
                console.log(data.data);
                if (data.code === 0) {
                    swal("预约成功!");
                }
            }
        });
    }


</script>
</body>
</html>